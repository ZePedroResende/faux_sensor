defmodule FauxSensor.Gateway do
  use Agent

  alias FauxSensor.Sensor
  alias FauxSensor.QrCode
  alias FauxSensor.TcpServer

  def init(ip, port) do
    Application.ensure_all_started(:inets)
    QrCode.generate(ip, port)
    send_request_create(ip, port)

    {:ok, pid} = TcpServer.start_link(ip, port)
    ref = Process.monitor(pid)
  end

  def add_sensor(gateway_pid) do
    Sensor.init(gateway_pid)
  end

  def send_request_create(ip, port) do
    {:ok, params} = Jason.encode(%{onboarding: %{ip: ip, port: port, uuid: Ecto.UUID.generate()}})

    :httpc.request(
      :post,
      {'http://localhost:4000/api/v1/onboarding', [], 'application/json', params},
      [],
      []
    )
  end
end
